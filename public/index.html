<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
        integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>QuoteSE</title>
    <link rel="stylesheet" href="styles.css">
    <!-- <script src="scripts.js"></script> -->
</head>

<body>
    <div class="container">
        <div class="headerContainer">
            <h1><span>Quote</span>SE</h1>
        </div>
    

        <section>
            <h2 class="subHeader">Description</h2>
            <div class="info">
                <h3>Purpose</h3>
                <p>To receive weekly inspiring <span>quotes</span> from legendary scientists and engineers!</p>
            </div>
        </section>

        <section>
            <h2 class="subHeader">Subscribe for <span>quotes</span></h2>
            <p class="preMsg">Subscribe to receive weekly empowerment</p>
            <p class="errMsg">Please ensure your email address is formatted correctly</p>
            <p class="subMsg">You Are Subscribed!</p>
            <div class="keyInput">
                <input id="userEmail" type="email" placeholder="Enter your email" />
            </div>
            <button id="signup_btn" class="addKey" type="button">
                <i class="fa-solid fa-check"></i>Subscribe
            </button>
        </section>

        <section>
            <h2 class="subHeader">Submit a <span>quote</span></h2>
            <p class="preMsg">Share your favorite <span>quotes</span> with the world!</p>
            <p class="quoteErrMsg">All Fields Are Required</p>
            <p class="quoteSubMsg">Quote Submitted!</p>
            <div class="info">
                <h3>Example Quote</h3>
                <p>"The most fruitful research grows out of practical problems." -Peck, R.B. (Geotechnical Eng.)</p>
            </div>
            <form method="POST" class="quoteSubmission">
                <input id="quoteText" type="text" placeholder="Quote (The most fruitful research grows out of practical problems)" class="gridInput1" maxlength="500" required />
                <input id="quoteAuthor" type="text" placeholder="Author (Peck, R.B.)" class="gridInput2" maxlength="100" required />
                <input id="quoteArea" type="text" placeholder="Area or field (Geotechnical Eng.)" class="gridInput3" maxlength="100" required />
            </form>
            <button id="share_btn" class="addKey" type="button">
                <i class="fa-solid fa-check"></i>Share
            </button>
        </section>

        <section>
            <div>Buy Me a Coffee</div>
        </section>
    </div>

</body>

<footer>
    <div class="container">
        <div class="footerContainer">
            <a class="first" href="https://github.com/liangchow" target="_blank">
                <i class="fa-regular fa-circle-question"></i>
            </a> 
        </div>
    </div>
</footer>

<script>
    const emailInput = document.getElementById('userEmail')
    const quoteTextInput = document.getElementById('quoteText')
    const quoteAuthorInput = document.getElementById('quoteAuthor')
    const quoteAreaInput = document.getElementById('quoteArea')
    
    const signup_btn = document.getElementById('signup_btn')
    const share_btn = document.getElementById('share_btn')
    
    const errMsg = document.querySelector('.errMsg')
    const subMsg = document.querySelector('.subMsg')
    const quoteErrMsg = document.querySelector('.quoteErrMsg')
    const quoteSubMsg = document.querySelector('.quoteSubMsg')
    const quoteForm = document.querySelector('.quoteSubmission')
    
    // Initially, hide all messages
    // errMsg.style.display = "none"
    // subMsg.style.display = "none"
    // quoteErrMsg.style.display = "none"
    // quoteSubMsg.style.display = "none"

    // Email verification criteria, e.g., j.doe@example.com
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/

    // Utility functions
    function trimInput(input){
        return input.trim().replace(/[<>]/g, '')
    }

    function hideMessages(message){
        message.forEach(msg => msg.style.display = "none")
    }



    async function signupNewUser(){
        const user_email = trimInput(emailInput.value)
        
        // Initially, hide all subscription messages
        hideMessages([errMsg, subMsg])

        // Email verification
        if (!user_email || !emailRegex.test(user_email)){
            errMsg.style.display = "inline"
            return
        }

        // Disable button on submit
        // signup_btn.style.pointerEvents = "none"
        signup_btn.style.opacity = "0.6" 

        try {
            const res = await fetch('/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: user_email })
            })
            if (!res.ok){
                throw new Error('Signup failed')
            }

            // if success
            subMsg.style.display = 'inline'
            emailInput.value = ''

        } catch(err){
            console.log('Signup error: ', err)
            errMsg.style.display = 'inline'
        } finally {
            // Restore button
            //signup_btn.style.pointerEvents = 'auto'
            signup_btn.style.opacity = "1.0"
        }
    }

    async function submitQuote(){
        const quote_text = trimInput(quoteTextInput.value)
        const quote_author = trimInput(quoteAuthorInput.value)
        const quote_area = trimInput(quoteAreaInput.value)
        
        // Initially, hide all submission messages
        hideMessages([quoteErrMsg, quoteSubMsg])

        // Required field
        if (!quote_text || !quote_author || !quote_area){
            quoteErrMsg.style.display = 'inline'
        }

        // Disable button on submit
        // share_btn.style.pointerEvents = "none"
        share_btn.style.opacity = "0.6" 

        try {
            const res = await fetch('/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    text: quote_text,
                    author: quote_author,
                    area : quote_area,
                })
            })
            if (!res.ok){
                throw new Error('Submission failed')
            }

            // if success
            quoteSubMsg.style.display = 'inline'
            quoteForm.reset()

        } catch(err){
            console.log('Submission error: ', err)
            quoteSubMsg.style.display = 'inline'
        } finally {
            // Restore button
            //share_btn.style.pointerEvents = 'auto'
            share_btn.style.opacity = "1.0"
            quoteForm.reset()
        }
    }

    // Tied in to button
    signup_btn.addEventListener('click', signupNewUser)
    share_btn.addEventListener('click', submitQuote)

    // Allow Enter key to submit
    emailInput.addEventListener('keypress', (e) => {
        if (e.key == "Enter"){
            e.preventDefault()
            signupNewUser()
        }
    })

    quoteForm.addEventListener('keypress', (e) => {
        if (e.key == "Enter" && !e.shiftKey){
            e.preventDefault()
            submitQuote()
        }
    })

</script>


</html>
